# S_01: PostgreSQL 18 多主单从逻辑复制配置方案

## 一、架构概述

### 1.1 服务器规划

| 服务器IP     | 角色              | 数据库                             | 权限   |
| ------------ | ----------------- | ---------------------------------- | ------ |
| 10.20.217.86 | 主节点 (Master 1) | 数据库A, 数据库B, 数据库C          | 可读写 |
| 10.20.217.89 | 主节点 (Master 2) | 数据库D                            | 可读写 |
| 10.20.217.87 | 从节点 (Slave)    | 数据库A, 数据库B, 数据库C, 数据库D | 只读   |

### 1.2 复制架构

```
┌─────────────────┐         ┌─────────────────┐
│  Master 1       │         │  Master 2       │
│  10.20.217.86   │         │  10.20.217.89   │
│                 │         │                 │
│  - Database_A   │         │  - Database_D   │
│  - Database_B   │         │                 │
│  - Database_C   │         │                 │
└────────┬────────┘         └────────┬────────┘
         │                           │
    Logical Rep                 Logical Rep
         │                           │
         └─────────────┬─────────────┘
                       │
         ┌───────────────────────────┐
         │  Slave                    │
         │  10.20.217.87             │
         │                           │
         │  - Database_A             │
         │  - Database_B             │
         │  - Database_C             │
         │  - Database_D             │
         └───────────────────────────┘
```

### 1.3 技术选型

采用 **逻辑复制（Logical Replication）** 方案，原因如下：

- 支持从多个发布者）订阅数据
- 可以选择性地复制特定的数据库
- 支持跨版本复制
- 从节点可以同时接收来自多个主节点的数据

## 二、前置条件

### 2.1 系统要求

- 操作系统：Linux (Ubuntu 24.04+)
- PostgreSQL 版本：18.x
- 网络互通：所有服务器之间网络可达
- 防火墙配置：开放 PostgreSQL 端口（默认 5432）

### 2.2 安装 PostgreSQL 18

在所有服务器上安装 PostgreSQL 18：

```bash
# Ubuntu/Debian
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt update
sudo apt install -y postgresql-18 postgresql-contrib-18
```

## 三、主节点配置

### 3.1 Master 1 (10.20.217.86) 配置

#### 3.1.1 修改 postgresql.conf

```bash
sudo vim /var/lib/pgsql/18/data/postgresql.conf
```

添加或修改以下配置：

```conf
# 连接设置
listen_addresses = '*'
max_connections = 200

# WAL 设置
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = 1GB

# 逻辑复制设置
max_logical_replication_workers = 10
max_sync_workers_per_subscription = 2

# 内存设置
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
work_mem = 16MB
```

#### 3.1.2 修改 pg_hba.conf

```bash
sudo vim /var/lib/pgsql/18/data/pg_hba.conf
```

添加以下规则：

```conf
# 允许从节点连接进行逻辑复制
host    replication     repl_user      10.20.217.87/32      scram-sha-256

# 允许从节点连接数据库进行订阅
host    all             repl_user      10.20.217.87/32      scram-sha-256

# 允许本地连接
host    all             all            127.0.0.1/32          scram-sha-256
host    all             all            ::1/128               scram-sha-256
```

#### 3.1.3 创建复制用户

```bash
sudo -u postgres psql
```

```sql
-- 创建复制用户
CREATE USER repl_user WITH REPLICATION ENCRYPTED PASSWORD 'your_strong_password_here';

-- 创建数据库
CREATE DATABASE database_a;
CREATE DATABASE database_b;
CREATE DATABASE database_c;

-- 授予复制用户访问权限
GRANT CONNECT ON DATABASE database_a TO repl_user;
GRANT CONNECT ON DATABASE database_b TO repl_user;
GRANT CONNECT ON DATABASE database_c TO repl_user;

GRANT USAGE ON SCHEMA public TO repl_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO repl_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO repl_user;

\q
```

#### 3.1.4 重启 PostgreSQL 服务

```bash
sudo systemctl restart postgresql
sudo systemctl enable postgresql
```

### 3.2 Master 2 (10.20.217.89) 配置

#### 3.2.1 修改 postgresql.conf

```bash
sudo vim /var/lib/pgsql/18/data/postgresql.conf
```

添加或修改以下配置：

```conf
# 连接设置
listen_addresses = '*'
max_connections = 200

# WAL 设置
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = 1GB

# 逻辑复制设置
max_logical_replication_workers = 10
max_sync_workers_per_subscription = 2

# 内存设置
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
work_mem = 16MB
```

#### 3.2.2 修改 pg_hba.conf

```bash
sudo vim /var/lib/pgsql/18/data/pg_hba.conf
```

添加以下规则：

```conf
# 允许从节点连接进行逻辑复制
host    replication     repl_user      10.20.217.87/32      scram-sha-256

# 允许从节点连接数据库进行订阅
host    all             repl_user      10.20.217.87/32      scram-sha-256

# 允许本地连接
host    all             all            127.0.0.1/32          scram-sha-256
host    all             all            ::1/128               scram-sha-256
```

#### 3.2.3 创建复制用户和数据库

```bash
sudo -u postgres psql
```

```sql
-- 创建复制用户
CREATE USER repl_user WITH REPLICATION ENCRYPTED PASSWORD 'your_strong_password_here';

-- 创建数据库
CREATE DATABASE database_d;

-- 授予复制用户访问权限
GRANT CONNECT ON DATABASE database_d TO repl_user;
GRANT USAGE ON SCHEMA public TO repl_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO repl_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO repl_user;

\q
```

#### 3.2.4 重启 PostgreSQL 服务

```bash
sudo systemctl restart postgresql
sudo systemctl enable postgresql
```

## 四、从节点配置

### 4.1 Slave (10.20.217.87) 配置

#### 4.1.1 修改 postgresql.conf

```bash
sudo vim /var/lib/pgsql/18/data/postgresql.conf
```

添加或修改以下配置：

```conf
# 连接设置
listen_addresses = '*'
max_connections = 200

# WAL 设置
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = 1GB

# 逻辑复制设置
max_logical_replication_workers = 20
max_sync_workers_per_subscription = 4
max_worker_processes = 20

# 内存设置
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
work_mem = 16MB

# 热备设置（如果需要查询时恢复）
hot_standby = on
```

#### 4.1.2 修改 pg_hba.conf

```bash
sudo vim /var/lib/pgsql/18/data/pg_hba.conf
```

添加以下规则：

```conf
# 允许应用服务器连接（只读）
host    all             app_user        0.0.0.0/0            scram-sha-256

# 允许本地连接
host    all             all            127.0.0.1/32          scram-sha-256
host    all             all            ::1/128               scram-sha-256
```

#### 4.1.3 创建数据库和表结构

```bash
sudo -u postgres psql
```

```sql
-- 创建数据库
CREATE DATABASE database_a;
CREATE DATABASE database_b;
CREATE DATABASE database_c;
CREATE DATABASE database_d;

-- 创建应用用户（用于只读访问）
CREATE USER app_user WITH ENCRYPTED PASSWORD 'app_user_password';

GRANT CONNECT ON DATABASE database_a TO app_user;
GRANT CONNECT ON DATABASE database_b TO app_user;
GRANT CONNECT ON DATABASE database_c TO app_user;
GRANT CONNECT ON DATABASE database_d TO app_user;

GRANT USAGE ON SCHEMA public TO app_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO app_user;

\q
```

#### 4.1.4 重启 PostgreSQL 服务

```bash
sudo systemctl restart postgresql
sudo systemctl enable postgresql
```

## 五、发布和订阅设置

### 5.1 在 Master 1 (10.20.217.86) 创建发布

```bash
sudo -u postgres psql
```

```sql
-- 为数据库A创建发布
\c database_a
CREATE PUBLICATION pub_database_a FOR ALL TABLES;

-- 为数据库B创建发布
\c database_b
CREATE PUBLICATION pub_database_b FOR ALL TABLES;

-- 为数据库C创建发布
\c database_c
CREATE PUBLICATION pub_database_c FOR ALL TABLES;

-- 查看发布
\dn *pub*
SELECT * FROM pg_publication;

\q
```

### 5.2 在 Master 2 (10.20.217.89) 创建发布

```bash
sudo -u postgres psql
```

```sql
-- 为数据库D创建发布
\c database_d
CREATE PUBLICATION pub_database_d FOR ALL TABLES;

-- 查看发布
SELECT * FROM pg_publication;

\q
```

### 5.3 在 Slave (10.20.217.87) 创建订阅

#### 5.3.1 创建订阅到 Master 1

```bash
sudo -u postgres psql
```

```sql
-- 订阅数据库A
\c database_a
CREATE SUBSCRIPTION sub_database_a 
CONNECTION 'host=10.20.217.86 port=5432 dbname=database_a user=repl_user password=your_strong_password_here' 
PUBLICATION pub_database_a
WITH (create_slot = false, slot_name = sub_database_a_slot);

-- 订阅数据库B
\c database_b
CREATE SUBSCRIPTION sub_database_b 
CONNECTION 'host=10.20.217.86 port=5432 dbname=database_b user=repl_user password=your_strong_password_here' 
PUBLICATION pub_database_b
WITH (create_slot = false, slot_name = sub_database_b_slot);

-- 订阅数据库C
\c database_c
CREATE SUBSCRIPTION sub_database_c 
CONNECTION 'host=10.20.217.86 port=5432 dbname=database_c user=repl_user password=your_strong_password_here' 
PUBLICATION pub_database_c
WITH (create_slot = false, slot_name = sub_database_c_slot);

\q
```

#### 5.3.2 创建订阅到 Master 2

```bash
sudo -u postgres psql
```

```sql
-- 订阅数据库D
\c database_d
CREATE SUBSCRIPTION sub_database_d 
CONNECTION 'host=10.20.217.89 port=5432 dbname=database_d user=repl_user password=your_strong_password_here' 
PUBLICATION pub_database_d
WITH (create_slot = false, slot_name = sub_database_d_slot);

\q
```

### 5.4 验证复制状态

#### 5.4.1 在 Slave 节点检查订阅状态

```bash
sudo -u postgres psql
```

```sql
-- 查看所有订阅状态
SELECT subname, subdbname, subslotname, subenabled, 
       substr(subconninfo, 1, 50) as connection_info
FROM pg_subscription;

-- 查看复制进度
SELECT * FROM pg_stat_subscription;

-- 查看复制槽
SELECT * FROM pg_replication_slots;

\q
```

#### 5.4.2 在 Master 节点检查发布状态

```bash
# Master 1
sudo -u postgres psql -c "SELECT * FROM pg_publication_tables;"

# Master 2
sudo -u postgres psql -c "SELECT * FROM pg_publication_tables;"
```

## 六、数据同步测试

### 6.1 在 Master 1 插入测试数据

```bash
sudo -u postgres psql
```

```sql
\c database_a
INSERT INTO sample_table_a (name) VALUES ('Test A1'), ('Test A2');

\c database_b
INSERT INTO sample_table_b (description, value) VALUES ('Description B1', 100.50);

\c database_c
INSERT INTO sample_table_c (status) VALUES ('Active'), ('Pending');

\q
```

### 6.2 在 Master 2 插入测试数据

```bash
sudo -u postgres psql
```

```sql
\c database_d
INSERT INTO sample_table_d (category, amount, transaction_date) 
VALUES ('Food', 25.99, '2024-01-15'), ('Transport', 15.50, '2024-01-16');

\q
```

### 6.3 在 Slave 验证数据同步

```bash
sudo -u postgres psql
```

```sql
\c database_a
SELECT * FROM sample_table_a;

\c database_b
SELECT * FROM sample_table_b;

\c database_c
SELECT * FROM sample_table_c;

\c database_d
SELECT * FROM sample_table_d;

\q
```

## 七、监控和维护

### 7.1 复制延迟监控

```sql
-- 在 Slave 节点执行
SELECT 
    subname,
    pg_stat_get_wal_lag(sublsn) AS replication_lag
FROM pg_subscription;
```

### 7.2 复制槽监控

```sql
-- 在 Master 节点执行
SELECT 
    slot_name,
    plugin,
    slot_type,
    active,
    restart_lsn,
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS lag_bytes
FROM pg_replication_slots
WHERE slot_type = 'logical';
```

### 7.3 订阅状态监控

```sql
-- 在 Slave 节点执行
SELECT 
    subname,
    subenabled,
    subslotname,
    pg_stat_get_subscription_stats(suboid) AS stats
FROM pg_subscription;
```

### 7.4 日志监控

```bash
# 查看 PostgreSQL 日志
sudo tail -f /var/lib/pgsql/18/data/log/postgresql-*.log

# 查看复制相关日志
sudo grep "replication" /var/lib/pgsql/18/data/log/postgresql-*.log
```

## 八、故障处理

### 8.1 订阅失败处理

```sql
-- 如果订阅失败，可以禁用并重新启用
ALTER SUBSCRIPTION sub_database_a DISABLE;
ALTER SUBSCRIPTION sub_database_a ENABLE;

-- 如果需要重新同步，可以刷新订阅
ALTER SUBSCRIPTION sub_database_a REFRESH PUBLICATION;
```

### 8.2 复制槽清理

```sql
-- 在 Master 节点，如果不再需要某个复制槽
SELECT pg_drop_replication_slot('sub_database_a_slot');
```

### 8.3 网络中断恢复

逻辑复制会自动在网络恢复后继续同步。如果长时间中断导致 WAL 文件被清理：

```sql
-- 在 Slave 节点重新创建订阅
DROP SUBSCRIPTION sub_database_a;
CREATE SUBSCRIPTION sub_database_a 
CONNECTION 'host=10.20.217.86 port=5432 dbname=database_a user=repl_user password=your_strong_password_here' 
PUBLICATION pub_database_a
WITH (create_slot = true);
```

### 8.4 数据不一致处理

如果发现数据不一致，可以重新初始化从节点：

```bash
# 1. 停止订阅
sudo -u postgres psql -c "ALTER SUBSCRIPTION sub_database_a DISABLE;"

# 2. 导出主节点数据
pg_dump -h 10.20.217.86 -U repl_user database_a > database_a_dump.sql

# 3. 在从节点删除并重新创建数据库
sudo -u postgres psql -c "DROP DATABASE database_a;"
sudo -u postgres psql -c "CREATE DATABASE database_a;"

# 4. 导入数据
psql database_a < database_a_dump.sql

# 5. 重新启用订阅
sudo -u postgres psql -c "ALTER SUBSCRIPTION sub_database_a ENABLE;"
```

## 九、性能优化建议

### 9.1 网络优化

- 确保主从节点之间网络带宽充足
- 考虑使用专用网络或 VPN
- 配置适当的 TCP 参数

### 9.2 PostgreSQL 参数调优

```conf
# 在 postgresql.conf 中调整以下参数

# 增加工作内存
work_mem = 32MB
maintenance_work_mem = 128MB

# 增加共享缓冲区
shared_buffers = 512MB

# 增加 WAL 缓冲区
wal_buffers = 16MB

# 增加检查点间隔
checkpoint_timeout = 15min
max_wal_size = 4GB
min_wal_size = 1GB

# 增加复制工作进程
max_logical_replication_workers = 20
max_sync_workers_per_subscription = 4
max_worker_processes = 20
```

### 9.3 表设计优化

- 为所有表添加主键（逻辑复制要求）
- 避免使用大对象（BLOB/CLOB）
- 考虑分区大表

## 十、安全建议

### 10.1 密码安全

- 使用强密码
- 定期更换密码
- 使用密码管理工具

### 10.2 网络安全

- 使用 SSL/TLS 加密连接
- 配置防火墙规则
- 使用 VPN 或专用网络

### 10.3 访问控制

- 遵循最小权限原则
- 定期审计访问日志
- 使用角色管理权限

### 10.4 数据加密

- 考虑使用透明数据加密（TDE）
- 加密备份文件
- 加密网络传输

## 十一、备份策略

### 11.1 主节点备份

```bash
# 使用 pg_dump 进行逻辑备份
pg_dump -U postgres database_a > database_a_backup_$(date +%Y%m%d).sql
pg_dump -U postgres database_b > database_b_backup_$(date +%Y%m%d).sql
pg_dump -U postgres database_c > database_c_backup_$(date +%Y%m%d).sql

# 使用 pg_basebackup 进行物理备份
pg_basebackup -h 10.20.217.86 -U repl_user -D /backup/master1 -Fp -Xs -P
```

### 11.2 从节点备份

```bash
# 从节点主要用于读取，备份频率可以较低
pg_dump -U postgres database_d > database_d_backup_$(date +%Y%m%d).sql
```

### 11.3 自动化备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份 Master 1
pg_dump -h 10.20.217.86 -U repl_user database_a > $BACKUP_DIR/database_a_$DATE.sql
pg_dump -h 10.20.217.86 -U repl_user database_b > $BACKUP_DIR/database_b_$DATE.sql
pg_dump -h 10.20.217.86 -U repl_user database_c > $BACKUP_DIR/database_c_$DATE.sql

# 备份 Master 2
pg_dump -h 10.20.217.89 -U repl_user database_d > $BACKUP_DIR/database_d_$DATE.sql

# 删除 7 天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
```

## 十二、故障切换方案

### 12.1 Master 1 故障切换

如果 Master 1 (10.20.217.86) 发生故障：

1. 将 Slave 提升为新的 Master 1
2. 修改应用连接配置
3. 修复原 Master 1 后，将其作为新的 Slave

### 12.2 Master 2 故障切换

如果 Master 2 (10.20.217.89) 发生故障：

1. 将 Slave 提升为新的 Master 2
2. 修改应用连接配置
3. 修复原 Master 2 后，将其作为新的 Slave

### 12.3 Slave 故障处理

如果 Slave (10.20.217.87) 发生故障：

1. 修复 Slave 节点
2. 重新创建订阅
3. 从 Master 节点重新同步数据

## 十三、常见问题

### 13.1 复制延迟高

**原因**：网络带宽不足、从节点性能不足、大量数据变更

**解决方案**：

- 增加网络带宽
- 升级从节点硬件
- 优化查询和事务
- 调整复制参数

### 13.2 复制中断

**原因**：网络中断、主节点重启、WAL 文件被清理

**解决方案**：

- 检查网络连接
- 重新启用订阅
- 重新同步数据

### 13.3 数据不一致

**原因**：手动修改从节点数据、复制失败未及时发现

**解决方案**：

- 严格限制从节点写入权限
- 定期检查数据一致性
- 建立监控告警机制

## 十四、总结

本配置方案实现了 PostgreSQL 18 的多主单从逻辑复制架构，具有以下特点：

1. **高可用性**：两个主节点分担写入压力
2. **数据集中**：从节点集中所有数据，便于查询和分析
3. **灵活扩展**：可以轻松添加更多主节点或从节点
4. **实时同步**：逻辑复制提供近实时的数据同步
5. **选择性复制**：可以选择性地复制特定的数据库和表

通过合理的配置和监控，可以确保系统的稳定运行和数据的一致性。

## 附录

### A. 配置文件完整示例

#### A.1 postgresql.conf (Master 节点)

```conf
# 连接设置
listen_addresses = '*'
port = 5432
max_connections = 200

# 内存设置
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
work_mem = 16MB

# WAL 设置
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = 1GB
wal_buffers = 16MB

# 逻辑复制设置
max_logical_replication_workers = 10
max_sync_workers_per_subscription = 2
max_worker_processes = 20

# 检查点设置
checkpoint_timeout = 15min
max_wal_size = 4GB
min_wal_size = 1GB

# 日志设置
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000

# 其他设置
shared_preload_libraries = 'pg_stat_statements'
```

#### A.2 pg_hba.conf (Master 节点)

```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# 允许从节点连接进行逻辑复制
host    replication     repl_user      10.20.217.87/32      scram-sha-256

# 允许从节点连接数据库进行订阅
host    all             repl_user      10.20.217.87/32      scram-sha-256

# 允许本地连接
host    all             all            127.0.0.1/32          scram-sha-256
host    all             all            ::1/128               scram-sha-256

# 允许应用服务器连接（可选）
host    all             app_user        0.0.0.0/0            scram-sha-256
```

### B. 有用的 SQL 查询

#### B.1 查看所有发布

```sql
SELECT 
    pubname,
    pubowner,
    puballtables,
    pubinsert,
    pubupdate,
    pubdelete,
    pubtruncate
FROM pg_publication;
```

#### B.2 查看发布的表

```sql
SELECT 
    p.pubname,
    n.nspname AS schema_name,
    c.relname AS table_name
FROM pg_publication p
JOIN pg_publication_rel pr ON p.oid = pr.prpubid
JOIN pg_class c ON pr.prrelid = c.oid
JOIN pg_namespace n ON c.relnamespace = n.oid
ORDER BY p.pubname, n.nspname, c.relname;
```

#### B.3 查看订阅状态

```sql
SELECT 
    subname,
    subdbname,
    subowner,
    subenabled,
    subslotname,
    subsynccommit,
    subpublications
FROM pg_subscription;
```

#### B.4 查看复制统计

```sql
SELECT 
    subname,
    pid,
    relid,
    received_lsn,
    last_msg_send_time,
    last_msg_receipt_time,
    latest_end_lsn,
    latest_end_time
FROM pg_stat_subscription;
```

### C. 参考资源

- PostgreSQL 官方文档：https://www.postgresql.org/docs/18/logical-replication.html
- PostgreSQL 逻辑复制最佳实践
- PostgreSQL 高可用架构设计
